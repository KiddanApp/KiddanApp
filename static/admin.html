<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punjabi Tutor Admin Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .lesson-card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
            background: white;
        }
        .lesson-header {
            background: #f8f9fa;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #dee2e6;
            cursor: move;
        }
        .step-card {
            border-left: 3px solid #007bff;
            margin: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
        }
        .drag-handle {
            cursor: grab;
            color: #6c757d;
            margin-right: 0.5rem;
        }
        .drag-handle:hover {
            color: #495057;
        }
        .admin-key-input {
            max-width: 300px;
        }
        .character-selector {
            margin-bottom: 1rem;
        }
        .lesson-form {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }
        .sortable-placeholder {
            background: #e9ecef;
            border: 2px dashed #dee2e6;
            margin: 0.5rem 0;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-cog"></i> Punjabi Tutor Admin Panel
            </span>
            <div class="d-flex">
                <input type="password" id="adminKey" class="form-control admin-key-input me-2"
                       placeholder="Enter Admin Key" value="">
                <button id="verifyKey" class="btn btn-outline-light">
                    <i class="fas fa-key"></i> Verify
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div id="authRequired" class="alert alert-warning">
            <i class="fas fa-lock"></i> Please enter your admin key to access the panel.
        </div>

        <div id="adminContent" class="d-none">
            <!-- Database Status & Seeding -->
            <div class="alert alert-info d-none" id="dbStatus">
                <i class="fas fa-database"></i>
                <span id="dbStatusText">Checking database status...</span>
                <button id="seedDatabaseBtn" class="btn btn-sm btn-primary ms-2 d-none">
                    <i class="fas fa-seedling"></i> Seed Database
                </button>
            </div>

            <!-- Character Selection -->
            <div class="character-selector">
                <label for="characterSelect" class="form-label">Select Character:</label>
                <select id="characterSelect" class="form-select">
                    <option value="">Choose a character...</option>
                </select>
            </div>

            <!-- Lessons Management -->
            <div id="lessonsSection" class="d-none">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3><i class="fas fa-book"></i> Lessons Management</h3>
                    <div>
                        <button id="addLessonBtn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Add New Lesson
                        </button>
                    </div>
                </div>

                <!-- Add Lesson Form -->
                <div id="addLessonForm" class="lesson-form d-none">
                    <h5><i class="fas fa-plus-circle"></i> Add New Lesson</h5>
                    <form id="lessonForm">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="lessonTitle" class="form-label">Lesson Title</label>
                                <input type="text" class="form-control" id="lessonTitle" required>
                            </div>
                            <div class="col-md-6">
                                <label for="insertPosition" class="form-label">Insert Position</label>
                                <select class="form-select" id="insertPosition">
                                    <option value="end">At End</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Save Lesson
                            </button>
                            <button type="button" id="cancelAddLesson" class="btn btn-secondary ms-2">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Lessons List -->
                <div id="lessonsList" class="sortable-list">
                    <!-- Lessons will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Lesson Modal -->
    <div class="modal fade" id="editLessonModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit"></i> Edit Lesson</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editLessonForm">
                        <input type="hidden" id="editLessonId">
                        <div class="mb-3">
                            <label for="editLessonTitle" class="form-label">Lesson Title</label>
                            <input type="text" class="form-control" id="editLessonTitle" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Steps</label>
                            <div id="stepsContainer">
                                <!-- Steps will be loaded here -->
                            </div>
                            <button type="button" id="addStepBtn" class="btn btn-outline-primary btn-sm mt-2">
                                <i class="fas fa-plus"></i> Add Step
                            </button>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="button" id="saveLessonChanges" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step Template (hidden) -->
    <div id="stepTemplate" class="d-none">
        <div class="step-card">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <select class="form-select form-select-sm step-type mb-2" style="width: auto; display: inline-block;">
                        <option value="info">Info</option>
                        <option value="mcq">Multiple Choice</option>
                        <option value="text">Text Input</option>
                        <option value="feedback">Feedback</option>
                        <option value="completion">Completion</option>
                    </select>
                    <div class="step-content">
                        <!-- Step content will be dynamically added -->
                    </div>
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm ms-2 remove-step">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>

    <script>
        // Global variables
        let currentCharacterId = '';
        let adminKey = '';
        let lessons = [];

        // Initialize
        $(document).ready(function() {
            $('#verifyKey').click(verifyAdminKey);
            $('#seedDatabaseBtn').click(seedDatabase);
            $('#addLessonBtn').click(showAddLessonForm);
            $('#cancelAddLesson').click(hideAddLessonForm);
            $('#lessonForm').submit(handleAddLesson);
            $('#saveLessonChanges').click(saveLessonChanges);
            $('#addStepBtn').click(addNewStep);

            // Make lessons list sortable
            $('#lessonsList').sortable({
                handle: '.drag-handle',
                placeholder: 'sortable-placeholder',
                update: handleLessonReorder
            });

            // Handle step type changes
            $(document).on('change', '.step-type', function() {
                const stepCard = $(this).closest('.step-card');
                const stepType = $(this).val();
                const contentDiv = stepCard.find('.step-content');

                // Create a mock step object for the new type
                const mockStep = {
                    lessonType: stepType,
                    characterMessage: {
                        romanPunjabi: '',
                        gurmukhi: '',
                        romanEnglish: '',
                        additionalNotes: ''
                    },
                    question: '',
                    options: [],
                    correctAnswers: []
                };

                contentDiv.html(generateStepContent(mockStep));
            });
        });

        // Verify admin key
        function verifyAdminKey() {
            adminKey = $('#adminKey').val().trim();
            if (!adminKey) {
                alert('Please enter admin key');
                return;
            }

            // Test with a simple API call
            fetch('/admin/characters', {
                headers: {
                    'X-Admin-Key': adminKey
                }
            })
            .then(response => {
                if (response.ok) {
                    $('#authRequired').addClass('d-none');
                    $('#adminContent').removeClass('d-none');
                    checkDatabaseStatus();
                    loadCharacters();
                } else {
                    alert('Invalid admin key');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error verifying admin key');
            });
        }

        // Load characters
        function loadCharacters() {
            fetch('/admin/characters', {
                headers: {
                    'X-Admin-Key': adminKey
                }
            })
            .then(response => response.json())
            .then(data => {
                const select = $('#characterSelect');
                select.empty();
                select.append('<option value="">Choose a character...</option>');

                data.forEach(character => {
                    select.append(`<option value="${character.id}">${character.name} (${character.id})</option>`);
                });

                select.change(handleCharacterChange);
            })
            .catch(error => {
                console.error('Error loading characters:', error);
                alert('Error loading characters');
            });
        }

        // Handle character selection change
        function handleCharacterChange() {
            currentCharacterId = $(this).val();
            if (currentCharacterId) {
                $('#lessonsSection').removeClass('d-none');
                loadLessons();
            } else {
                $('#lessonsSection').addClass('d-none');
            }
        }

        // Load lessons for selected character
        function loadLessons() {
            fetch(`/admin/lessons/${currentCharacterId}`, {
                headers: {
                    'X-Admin-Key': adminKey
                }
            })
            .then(response => response.json())
            .then(data => {
                lessons = data.lessons || [];
                renderLessons();
                updateInsertPositions();
            })
            .catch(error => {
                console.error('Error loading lessons:', error);
                alert('Error loading lessons');
            });
        }

        // Render lessons list
        function renderLessons() {
            const container = $('#lessonsList');
            container.empty();

            lessons.forEach((lesson, index) => {
                // Get character message from first step
                const firstStep = lesson.steps?.[0];
                const characterMessage = firstStep?.characterMessage?.romanPunjabi || 'No message set';

                // Truncate long messages for display
                const truncatedMessage = characterMessage.length > 100
                    ? characterMessage.substring(0, 100) + '...'
                    : characterMessage;

                const lessonCard = $(`
                    <div class="lesson-card" data-lesson-id="${lesson.id}">
                        <div class="lesson-header">
                            <i class="fas fa-grip-vertical drag-handle"></i>
                            <strong>${lesson.title}</strong>
                            <span class="badge bg-secondary ms-2">${lesson.steps?.length || 0} steps</span>
                            <div class="float-end">
                                <button class="btn btn-sm btn-outline-primary me-1 edit-lesson" data-lesson-id="${lesson.id}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-lesson" data-lesson-id="${lesson.id}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="p-3">
                            <div class="mb-2">
                                <small class="text-muted">Character Message:</small>
                                <div class="mt-1 p-2 bg-light rounded small">${truncatedMessage}</div>
                            </div>
                            <small class="text-muted">ID: ${lesson.id}</small>
                        </div>
                    </div>
                `);

                container.append(lessonCard);
            });

            // Bind event handlers
            $('.edit-lesson').click(function() {
                const lessonId = $(this).data('lesson-id');
                editLesson(lessonId);
            });

            $('.delete-lesson').click(function() {
                const lessonId = $(this).data('lesson-id');
                deleteLesson(lessonId);
            });
        }

        // Update insert positions dropdown
        function updateInsertPositions() {
            const select = $('#insertPosition');
            select.empty();
            select.append('<option value="end">At End</option>');

            lessons.forEach((lesson, index) => {
                select.append(`<option value="${index}">Before "${lesson.title}"</option>`);
            });
        }

        // Show add lesson form
        function showAddLessonForm() {
            $('#addLessonForm').removeClass('d-none');
            $('#lessonTitle').val('');
            $('#addLessonBtn').addClass('d-none');
        }

        // Hide add lesson form
        function hideAddLessonForm() {
            $('#addLessonForm').addClass('d-none');
            $('#addLessonBtn').removeClass('d-none');
        }

        // Handle add lesson form submission
        function handleAddLesson(e) {
            e.preventDefault();

            const title = $('#lessonTitle').val().trim();
            const position = $('#insertPosition').val();

            if (!title) {
                alert('Please enter lesson title');
                return;
            }

            const lessonData = {
                id: `lesson-${Date.now()}`,
                characterId: currentCharacterId,
                title: title,
                steps: [{
                    lessonType: 'info',
                    emotion: 'happy',
                    characterMessage: {
                        romanPunjabi: 'Welcome to this lesson!',
                        gurmukhi: 'ਇਸ ਲੈਸਨ ਵਿੱਚ ਜੀ ਆਇਆਂ ਨੂੰ!',
                        romanEnglish: 'Welcome to this lesson!',
                        additionalNotes: 'Basic greeting in Punjabi'
                    },
                    question: '',
                    options: [],
                    correctAnswers: []
                }]
            };

            if (position === 'end') {
                // Add to end
                fetch('/admin/lessons', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': adminKey
                    },
                    body: JSON.stringify(lessonData)
                })
                .then(response => response.json())
                .then(data => {
                    hideAddLessonForm();
                    loadLessons();
                })
                .catch(error => {
                    console.error('Error adding lesson:', error);
                    alert('Error adding lesson');
                });
            } else {
                // Insert at position
                const positionIndex = parseInt(position);
                fetch(`/admin/lessons/${currentCharacterId}/insert`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Admin-Key': adminKey
                    },
                    body: JSON.stringify({
                        position: positionIndex,
                        lesson: lessonData
                    })
                })
                .then(response => {
                    if (response.ok) {
                        hideAddLessonForm();
                        loadLessons();
                    } else {
                        alert('Error inserting lesson');
                    }
                })
                .catch(error => {
                    console.error('Error inserting lesson:', error);
                    alert('Error inserting lesson');
                });
            }
        }

        // Edit lesson
        function editLesson(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            if (!lesson) return;

            $('#editLessonId').val(lessonId);
            $('#editLessonTitle').val(lesson.title);

            // Render steps
            renderSteps(lesson.steps || []);

            $('#editLessonModal').modal('show');
        }

        // Render steps in edit modal
        function renderSteps(steps) {
            const container = $('#stepsContainer');
            container.empty();

            steps.forEach((step, index) => {
                const stepCard = createStepElement(step);
                container.append(stepCard);
            });
        }

        // Create step element
        function createStepElement(step) {
            const stepDiv = $('#stepTemplate .step-card').clone();
            stepDiv.find('.step-type').val(step.lessonType);

            const contentDiv = stepDiv.find('.step-content');
            contentDiv.html(generateStepContent(step));

            stepDiv.find('.remove-step').click(function() {
                $(this).closest('.step-card').remove();
            });

            return stepDiv;
        }

        // Generate step content based on type
        function generateStepContent(step) {
            let content = '';

            switch (step.lessonType) {
                case 'info':
                    content = `
                        <div class="mb-2">
                            <label class="form-label">Roman Punjabi</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="romanPunjabi">${step.characterMessage?.romanPunjabi || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Gurmukhi</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="gurmukhi">${step.characterMessage?.gurmukhi || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">English</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="romanEnglish">${step.characterMessage?.romanEnglish || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Additional Notes (optional)</label>
                            <input type="text" class="form-control form-control-sm" value="${step.characterMessage?.additionalNotes || ''}" data-field="additionalNotes">
                        </div>
                    `;
                    break;
                case 'mcq':
                    content = `
                        <div class="mb-2">
                            <label class="form-label">Question</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="question">${step.question || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Options (one per line)</label>
                            <textarea class="form-control form-control-sm" rows="4" data-field="options">${(step.options || []).join('\n')}</textarea>
                        </div>

                         <div class="mb-2">
                            <label class="form-label">Roman Punjabi</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="romanPunjabi">${step.characterMessage?.romanPunjabi || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Gurmukhi</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="gurmukhi">${step.characterMessage?.gurmukhi || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">English</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="romanEnglish">${step.characterMessage?.romanEnglish || ''}</textarea>
                        </div>
                        
                        <div class="mb-2">
                            <label class="form-label">Correct Answers (comma-separated)</label>
                            <input type="text" class="form-control form-control-sm" value="${(step.correctAnswers || []).join(', ')}" data-field="correctAnswers">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Additional Notes (optional)</label>
                            <input type="text" class="form-control form-control-sm" value="${step.characterMessage?.additionalNotes || ''}" data-field="additionalNotes">
                        </div>
                    `;
                    break;
                case 'text':
                    content = `
                        <div class="mb-2">
                            <label class="form-label">Question/Prompt</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="question">${step.question || ''}</textarea>
                        </div>

                         <div class="mb-2">
                            <label class="form-label">Roman Punjabi</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="romanPunjabi">${step.characterMessage?.romanPunjabi || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">Gurmukhi</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="gurmukhi">${step.characterMessage?.gurmukhi || ''}</textarea>
                        </div>
                        <div class="mb-2">
                            <label class="form-label">English</label>
                            <textarea class="form-control form-control-sm" rows="2" data-field="romanEnglish">${step.characterMessage?.romanEnglish || ''}</textarea>
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Correct Answers (comma-separated)</label>
                            <input type="text" class="form-control form-control-sm" value="${(step.correctAnswers || []).join(', ')}" data-field="correctAnswers">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">Additional Notes (optional)</label>
                            <input type="text" class="form-control form-control-sm" value="${step.characterMessage?.additionalNotes || ''}" data-field="additionalNotes">
                        </div>
                    `;
                    break;
                case 'feedback':
                    content = `
                        <div class="mb-2">
                            <label class="form-label">Feedback Message</label>
                            <textarea class="form-control form-control-sm" rows="3" data-field="characterMessage.romanPunjabi">${step.characterMessage?.romanPunjabi || ''}</textarea>
                        </div>
                    `;
                    break;
                case 'completion':
                    content = `
                        <div class="mb-2">
                            <label class="form-label">Completion Message</label>
                            <textarea class="form-control form-control-sm" rows="3" data-field="characterMessage.romanPunjabi">${step.characterMessage?.romanPunjabi || ''}</textarea>
                        </div>
                    `;
                    break;
            }

            return content;
        }

        // Add new step
        function addNewStep() {
            const newStep = {
                lessonType: 'info',
                emotion: '',
                characterMessage: {
                    romanPunjabi: '',
                    gurmukhi: '',
                    romanEnglish: '',
                    additionalNotes: ''
                },
                question: '',
                options: [],
                correctAnswers: []
            };

            const stepElement = createStepElement(newStep);
            $('#stepsContainer').append(stepElement);
        }

        // Save lesson changes
        function saveLessonChanges() {
            const lessonId = $('#editLessonId').val();
            const title = $('#editLessonTitle').val().trim();

            if (!title) {
                alert('Please enter lesson title');
                return;
            }

            // Collect steps data
            const steps = [];
            $('#stepsContainer .step-card').each(function(index) {
                const stepCard = $(this);
                const stepType = stepCard.find('.step-type').val();

                const step = {
                    lessonType: stepType,
                    emotion: '',
                    question: '',
                    options: [],
                    correctAnswers: []
                };

                // Collect step-specific data
                switch (stepType) {
                    case 'info':
                        step.characterMessage = {
                            romanPunjabi: stepCard.find('[data-field="romanPunjabi"]').val(),
                            gurmukhi: stepCard.find('[data-field="gurmukhi"]').val(),
                            romanEnglish: stepCard.find('[data-field="romanEnglish"]').val(),
                            additionalNotes: stepCard.find('[data-field="additionalNotes"]').val()
                        };
                        break;
                    case 'mcq':
                        step.question = stepCard.find('[data-field="question"]').val();
                        step.options = stepCard.find('[data-field="options"]').val().split('\n').filter(opt => opt.trim());
                        step.correctAnswers = stepCard.find('[data-field="correctAnswers"]').val().split(',').map(ans => ans.trim()).filter(ans => ans);
                        // Also collect character message for MCQ steps
                        step.characterMessage = {
                            romanPunjabi: stepCard.find('[data-field="romanPunjabi"]').val(),
                            gurmukhi: stepCard.find('[data-field="gurmukhi"]').val(),
                            romanEnglish: stepCard.find('[data-field="romanEnglish"]').val(),
                            additionalNotes: stepCard.find('[data-field="additionalNotes"]').val()
                        };
                        
                        break;
                    case 'text':
                        step.question = stepCard.find('[data-field="question"]').val();
                        step.correctAnswers = stepCard.find('[data-field="correctAnswers"]').val().split(',').map(ans => ans.trim()).filter(ans => ans);
                        // Also collect character message for text steps
                        step.characterMessage = {
                            romanPunjabi: stepCard.find('[data-field="romanPunjabi"]').val(),
                            gurmukhi: stepCard.find('[data-field="gurmukhi"]').val(),
                            romanEnglish: stepCard.find('[data-field="romanEnglish"]').val(),
                            additionalNotes: stepCard.find('[data-field="additionalNotes"]').val()
                        };
                        break;
                    case 'feedback':
                    case 'completion':
                        step.characterMessage = {
                            romanPunjabi: stepCard.find('[data-field="characterMessage.romanPunjabi"]').val(),
                            gurmukhi: '',
                            romanEnglish: '',
                            additionalNotes: ''
                        };
                        break;
                }

                steps.push(step);
            });

            const lessonData = {
                title: title,
                steps: steps
            };

            fetch(`/admin/lessons/${currentCharacterId}/${lessonId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify(lessonData)
            })
            .then(response => {
                if (response.ok) {
                    $('#editLessonModal').modal('hide');
                    loadLessons();
                } else {
                    alert('Error updating lesson');
                }
            })
            .catch(error => {
                console.error('Error updating lesson:', error);
                alert('Error updating lesson');
            });
        }

        // Delete lesson
        function deleteLesson(lessonId) {
            if (!confirm('Are you sure you want to delete this lesson?')) return;

            fetch(`/admin/lessons/${currentCharacterId}/${lessonId}`, {
                method: 'DELETE',
                headers: {
                    'X-Admin-Key': adminKey
                }
            })
            .then(response => {
                if (response.ok) {
                    loadLessons();
                } else {
                    alert('Error deleting lesson');
                }
            })
            .catch(error => {
                console.error('Error deleting lesson:', error);
                alert('Error deleting lesson');
            });
        }

        // Check database status
        function checkDatabaseStatus() {
            $('#dbStatus').removeClass('d-none');
            $('#dbStatusText').text('Checking database status...');
            $('#seedDatabaseBtn').addClass('d-none');

            fetch('/admin/characters', {
                headers: {
                    'X-Admin-Key': adminKey
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    $('#dbStatusText').text('Database is empty. Click to seed with initial data.');
                    $('#seedDatabaseBtn').removeClass('d-none');
                } else {
                    $('#dbStatusText').text(`Database ready: ${data.length} characters loaded.`);
                    $('#seedDatabaseBtn').addClass('d-none');
                }
            })
            .catch(error => {
                console.error('Error checking database status:', error);
                $('#dbStatusText').text('Error checking database status.');
            });
        }

        // Seed database
        function seedDatabase() {
            $('#dbStatusText').text('Seeding database... Please wait.');
            $('#seedDatabaseBtn').prop('disabled', true);

            fetch('/seed-database', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    $('#dbStatusText').text(`${data.message} (${data.characters_seeded || 0} characters, ${data.lesson_sets_seeded || 0} lesson sets)`);
                    $('#seedDatabaseBtn').addClass('d-none');
                    // Reload characters after seeding
                    setTimeout(() => {
                        loadCharacters();
                    }, 1000);
                } else if (data.error) {
                    $('#dbStatusText').text(`Error: ${data.error}`);
                    $('#seedDatabaseBtn').prop('disabled', false);
                }
            })
            .catch(error => {
                console.error('Error seeding database:', error);
                $('#dbStatusText').text('Error seeding database.');
                $('#seedDatabaseBtn').prop('disabled', false);
            });
        }



        // Handle lesson reordering
        function handleLessonReorder() {
            const newOrder = [];
            $('#lessonsList .lesson-card').each(function() {
                const lessonId = $(this).data('lesson-id');
                newOrder.push(lessonId);
            });

            fetch(`/admin/lessons/${currentCharacterId}/reorder`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify({
                    lesson_ids: newOrder
                })
            })
            .then(response => {
                if (!response.ok) {
                    alert('Error reordering lessons');
                    loadLessons(); // Reload to revert changes
                }
            })
            .catch(error => {
                console.error('Error reordering lessons:', error);
                alert('Error reordering lessons');
                loadLessons(); // Reload to revert changes
            });
        }
    </script>
</body>
</html>
